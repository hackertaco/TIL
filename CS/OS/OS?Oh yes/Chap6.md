## 교착 상태
자원이 한정적인 상태에서, 각 프로세스들이 자신이 확보한 자원을 가진 채 상대방의 자원을 필요로 할 경우, 교착상태가 발생할 수 있다.
이는 한정적인 자원보다 프로세스의 요청이 더 많기 때문이다.

물론 자원이 넘쳐나면 좋겠지만, 이미 가지고 있는 자원에서 최대의 효과를 누리는 것이 운영체제의 역할이므로, 권장되지는 않는다.

교착상태의 문제점은
- 프로세스들이 실행되지 못해 사용자에게 응답이 불가
- 보유된 자원들이 전혀 활동되지 못함

### 자원이란? 
1. 선점 / 비선점
   - 선점: CPU, 메모리처럼 한 프로세스에 할당했다가 다시 다른 프로세스에게 돌려주어도 되는 자원. 다중 프로그래밍을 위해 필요하다
   - 비선점: 선점이 될 경우 정상적인 진행을 포기해야하는 자원 (프린트와 같은). 시스템의 정상진행을 위해 필요하다
2. 공유가능 / 배타적
   - 공유 가능 : 한 프로세스에 할당된 자원을 동시에 다른 프로세스가 할당받아 사용할 수 있는지
   - 배타적: 다른 프로세스와 동시에 사용 불가능(CPU, 메모리, 버퍼)
3. 순차적 재사용 가능 / 소모성 
   - 재사용 가능: 반납이 되었을 때 자원 자체는 계속 존재하여 다른 프로세스에 할당 가능(CPU, 메모리)
   - 소모성: 일시적 생성 -> 사라짐 (메세지)

### 프로세스는?
자원과 관련해 프로세스가 취하는 행동
1. 자원에 대한 요청
    if(사용 가능): 할당받아 사용
    else: 해당 자원이 반납될 때까지 대기 상태 
2. 사용이 끝난 자원의 반납
   - 이는 운영체제에 의해서 이루어진다. (시스템 콜)

### 교착상태의 원인
네 가지가 있으며, 이 조건 모두가 충족될 때 교착상태가 일어난다.

1. 자원의 배타적인 사용
   - 교착 상태는 한정적 자원에 대한 프로세스들의 사용 경쟁 때문이다. 
   - 상호배제 조건이라고도 한다.
2. 자원의 부분 할당
   - 필요한 자원 확보한 상태에서 추가로 필요한 것을 요청했다가 대기상태로 되는. 
   - 보유와 대기 조건
3. 자원의 선점 불가능성
   - 자원의 선점 불가능성을 고수하게 될 경우 교착 상태의 원인이된다.
   - 비선점 조건
4. 자원에 대한 환형 대기
   - 프로세스가 이미 선점되어있는 어떤 자원을 필요로 하고, 해당 자원을 선점한 프로세스가 처음 프로세스가 선점해있는 자원을 요청할 때
   - 사이클이 생긴다.

## 교착 상태의 해결
1. 예방
   - 교착 상태를 아예 발생되지않도록
2. 회피
   - 교착 상태를 피해가도록
3. 탐지
   - 교착 상태가 발생되도록 놓아두었다가 발생 시 교착 상태를 탐지해 조치하는 방법
4. 복구
   - 탐지와 함께 간다.

### 예방
- 자원의 배타적 사용 조건을 배제
  - 불가능. 배타적으로 사용할 수밖에 없는 자원이 있다.
- 자원의 부분 할당을 배제
  - 필요한 자원이 모두 사용 가능할 때만 실행.
  - 이 경우 무한 대기/자원 낭비
- 자원의 선점 불가능을 배제
  - 선점 불가능한 자원을 선점하게 되어 무한 대기가 발생할 수 있음.
  - 비정상적인 종료. 처음부터 다시 시작 등
- 자원의 환형 대기 상황을 배제
  - 자원들끼리의 순서를 정해서 해당 자원을 선점한 프로세스가 우선
  - 이 경우에도 무한 대기와 자원의 낭비.

### 회피
- 은행가 알고리즘
  - 안전상태에 대한 개념
    - 유한 시간 내에 정상적으로 종료되는 상태.
  - 불안정 상태란, 안전상태가 아닌 경우.
    - 그렇다고 모든 불안정 상태가 교착상태는 아니며, 그럴 가능성이 높을 뿐이고, 그럴 경우의 방지책이 없다는 것.
  - 회피는 안정 상태로만 가도록 제어해 나가는 것이다. 
  - 시스템에 대한 몇 가지 가정이 은행가 알고리즘에 요구된다.
    - 프로세스 수 고정
    - 자원 수 고정
    - 프로세스 요구할 자원의 최대 개수 알려져야
    - 프로세스가 자원을 사용 후 반드시 반납
    - 이 네가지 중 1, 3은 이론적으로만 가능. 
  - 현 상태에서 모든 프로세스가 정상적으로 종료할 수 있는 방법이 하나 이상 있는가를 판단.

### 탐지
1. 어떤 프로세스가 어떤 자원을 가지고 있는가?
2. 어떤 프로세스가 어떤 자원에 의해 대기 상태가 되어있는가?
에 대한 정보가 있는 경우, 자원 할당 그래프로 교착 상태 여부를 확인할 수 있다.

이를 RAG이라 하고, (Resource Allocation Graph)
- 프로세스와 자원을 노드로 표현. 프로세스는 동그라미, 자원은 네모, 자원 안의 작은 동그라미는 자원의 개수
- 이는 여유량이 있는 자원 및 대기 상태가 아닌 프로세스 정보를 알려줄 수 있다. 
- 싱크라는 프로세스는, 자원으로 향하는 에지가 없는 프로세스다. 
  - 탐지는 이를 먼저 찾아서, 에지를 제거한다. 이 방식으로 자꾸 에지를 지워나갈 수 있다면 교착상태가 없는것
  - 지워나갈 수 없는 에지가 있다면 교착 상태가 있는 것
- 그래프 탐색으로도 탐지 가능.
  - 자원의 할당과 반납과는 상관 없이, 요청 후 대기상태로 될 때가 교착 상태를 형성시킬 가능성이있다.
    - 이 때 싱크가 있다면 교착 상태가 없고
    - 노드 자신으로 되돌아오는 사이클이 잇으면 교착상태. 그런데 사이클을 발견할 경우 그것이 곧 교착상태는 아니고, 모든 자원 형이 한 개씩의 자원을 가질 경우다. 혹은 한 자원에 다수 개의 자원이 있을 경우, 노트라는 자료구조의 발견이 곧 교착 상태다.

### 복구
교착 상태에서 어떻게 벗어날 것인가? 
- 강제로 종료
  - 어떤 프로세스들을 종료할지..
    - 종료 비용 최소화하기위해, 해당 비용이 최소인 프로세스부터 종료하거나 (프로세스 종료할 때마다 교착상태 제거 확인해야)
    - 프로세스의 집합에서 가능한 모든 부분집합을 만들어 집합들에 속하는 프로세스들을 종료시켯을 경우의 비용을 따져서 한꺼번에 종료하기도 한다. (이는 모든 부분집합 비용 계산 어려움, 복잡.)
      - 종료 비용의 최소화
    - 우선순위가 낮고, 실시간이 아니고, 실행된 시간의 크기가 짧을수록, 남은시간이 클 수록 종료비용이 적게든다
    - 복구 비용을 키우는 주 요인, 낭비를 줄이려고 검사점 지정, 재시작을 하게된다. 
- 아니면 추가의 자원을 가져오기
  - 다른 선점 자원을 가져온다. 
  - 선점 시 최소 비용을 따져야한다. 



